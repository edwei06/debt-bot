services:
  bot:
    build: .
    env_file: .env
    working_dir: /app
    restart: always
    volumes:
      - type: bind
        source: D:\vscode\debt-bot\discord-bot\data
        target: /data
    # ---- 資源限制（避免拖垮主機）----
    mem_limit: 600m
    memswap_limit: 1g
    cpus: "0.60"
    pids_limit: 128
    stop_grace_period: 15s
    # ---- 健康檢查：確保 DB 可用、程式沒卡死 ----
    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3,os;sqlite3.connect(os.getenv('LEDGER_DB','/data/ledger.db')).execute('select 1')"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    # ---- 日誌旋轉，避免把磁碟寫爆 ----
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
